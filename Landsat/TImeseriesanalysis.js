/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var box = 
    /* color: #d63000 */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[85.96157732276663, 24.067975203051876],
          [85.96157732276663, 23.58557842798371],
          [86.79104509620413, 23.58557842798371],
          [86.79104509620413, 24.067975203051876]]], null, false),
    farms = /* color: #d63000 */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([85.5248707797978, 24.10075309177992]),
            {
              "farm_id": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([85.8874196079228, 24.0756790465053]),
            {
              "farm_id": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([85.7885426547978, 23.749271613301364]),
            {
              "farm_id": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([86.5026539829228, 23.809593437264606]),
            {
              "farm_id": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([86.5301198032353, 24.17093429743662]),
            {
              "farm_id": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([86.7553395297978, 23.970314551264263]),
            {
              "farm_id": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([86.7113942172978, 23.769381996845738]),
            {
              "farm_id": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([86.4147633579228, 23.663767853564316]),
            {
              "farm_id": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([86.0961598422978, 23.507705298137907]),
            {
              "farm_id": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([85.6402272251103, 23.568138621468375]),
            {
              "farm_id": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([85.4314869907353, 23.68389142475802]),
            {
              "farm_id": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([85.4095143344853, 23.85984022971935]),
            {
              "farm_id": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([85.4479664829228, 23.990390634883177]),
            {
              "farm_id": 1,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([86.0082692172978, 23.95023533954767]),
            {
              "farm_id": 1,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([85.7226246860478, 24.010463588427253]),
            {
              "farm_id": 1,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([85.6457203891728, 23.849792428828966]),
            {
              "farm_id": 1,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([85.6292408969853, 24.02551624828537]),
            {
              "farm_id": 1,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([85.8819264438603, 23.93015300171239]),
            {
              "farm_id": 1,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([85.9862965610478, 23.68892183330301]),
            {
              "farm_id": 1,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([86.0741871860478, 23.794515605101225]),
            {
              "farm_id": 1,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Point([86.3103932407353, 23.809593437264606]),
            {
              "farm_id": 1,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Point([86.7718190219853, 23.673830026501268]),
            {
              "farm_id": 1,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Point([86.8157643344853, 23.839743848889533]),
            {
              "farm_id": 1,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Point([86.6729420688603, 23.68389142475802]),
            {
              "farm_id": 1,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Point([86.5411061313603, 23.447244235783664]),
            {
              "farm_id": 1,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Point([86.2060231235478, 23.68892183330301]),
            {
              "farm_id": 1,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Point([86.2939137485478, 23.60841206621214]),
            {
              "farm_id": 1,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Point([86.4367360141728, 23.658736476669112]),
            {
              "farm_id": 1,
              "system:index": "27"
            }),
        ee.Feature(
            ee.Geometry.Point([86.5740651157353, 23.69395204808399]),
            {
              "farm_id": 1,
              "system:index": "28"
            }),
        ee.Feature(
            ee.Geometry.Point([86.4861744907353, 23.57820814134667]),
            {
              "farm_id": 1,
              "system:index": "29"
            }),
        ee.Feature(
            ee.Geometry.Point([86.3763112094853, 23.5177794464871]),
            {
              "farm_id": 1,
              "system:index": "30"
            }),
        ee.Feature(
            ee.Geometry.Point([86.2115162876103, 23.698982069069647]),
            {
              "farm_id": 1,
              "system:index": "31"
            }),
        ee.Feature(
            ee.Geometry.Point([85.88775483981772, 23.608565653275427]),
            {
              "farm_id": 1,
              "system:index": "32"
            }),
        ee.Feature(
            ee.Geometry.Point([85.87676851169272, 23.538079100118352]),
            {
              "farm_id": 1,
              "system:index": "33"
            }),
        ee.Feature(
            ee.Geometry.Point([85.99761812106772, 23.618632070672707]),
            {
              "farm_id": 1,
              "system:index": "34"
            }),
        ee.Feature(
            ee.Geometry.Point([85.93170015231772, 23.885109583251683]),
            {
              "farm_id": 1,
              "system:index": "35"
            }),
        ee.Feature(
            ee.Geometry.Point([86.16241304294272, 24.07081668936453]),
            {
              "farm_id": 1,
              "system:index": "36"
            }),
        ee.Feature(
            ee.Geometry.Point([86.23931733981772, 23.92528514268002]),
            {
              "farm_id": 1,
              "system:index": "37"
            }),
        ee.Feature(
            ee.Geometry.Point([86.31072847263022, 24.040720221920065]),
            {
              "farm_id": 1,
              "system:index": "38"
            }),
        ee.Feature(
            ee.Geometry.Point([86.39312593356772, 24.045736789854757]),
            {
              "farm_id": 1,
              "system:index": "39"
            }),
        ee.Feature(
            ee.Geometry.Point([86.57989351169272, 24.045736789854757]),
            {
              "farm_id": 1,
              "system:index": "40"
            })]),
    L8 = ee.ImageCollection("LANDSAT/LC08/C02/T1_L2"),
    modis = ee.ImageCollection("MODIS/006/MOD13Q1");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
Map.addLayer(farms,{color: 'red'}, 'Farm')
// var filtered = L8.filter(ee.Filter.date('2014-04-01', '2015-03-30'),
// ee.Filter.bounds((farms))
// // print(filtered)
var filtered = modis.filter(ee.Filter.date('2014-04-01', '2015-03-30'))
// print(filtered)
var modisNDVI = filtered.select('NDVI')
// print(modisNDVI)
// var image = ee.Image(modisNDVI.first())
// var scaledImage = image.multiply(0.0001)

// var visParams = {
//   min: 0,
//   max: 1,
//   palette: ['white', 'green']
// }
// Map.addLayer(scaledImage, visParams,'NDVI')
var scaledNDVI = modisNDVI.map(function(image)  {
  return image.multiply(0.0001)
  .copyProperties(image, ['system:time_start', 'system:time_end'])
})
// print(scaledNDVI)
// // ******Ndvi of one of the farm chart ******// //
// var testFarm = ee.Feature(farms.first())
// var chart = ui.Chart.image.series({
//   imageCollection: scaledNDVI, 
//   region: testFarm.geometry(),
//   reducer: ee.Reducer.mean(), 
//   scale: 250}).setOptions({
//       interpolateNulls: true,
//       lineWidth: 1,
//       pointSize: 3,
//       title: 'NDVI over Time at a Single Location',
//       vAxis: {title: 'NDVI'},
//       hAxis: {title: 'Date', format: 'YYYY-MMM', gridlines: {count: 12}}
//     })
//   print(chart)

// // *****Extract time series for all points in the farms *****// //
var triplets = scaledNDVI.map(function(image){
  var withstats = image.reduceRegions({
    collection: farms, 
    reducer: ee.Reducer.mean().setOutputs(['NDVI']), 
    scale: 250, })
    .map(function(feature){
      return feature.set('imageId', image.id())
    })
    return withstats
}).flatten()
print(triplets.first())

var format = function(table, rowId, colId) {
  var rows = table.distinct(rowId); 
  var joined = ee.Join.saveAll('matches').apply({
    primary: rows, 
    secondary: table, 
    condition: ee.Filter.equals({
      leftField: rowId, 
      rightField: rowId
    })
  });
         
  return joined.map(function(row) {
      var values = ee.List(row.get('matches'))
        .map(function(feature) {
          feature = ee.Feature(feature);
          var ndvi = ee.List([feature.get('ndvi'), -9999])
            .reduce(ee.Reducer.firstNonNull())
          return [feature.get(colId), ee.Number(ndvi).format('%.3f')];
        });
      return row.select([rowId]).set(ee.Dictionary(values.flatten()));
    });
};

var timeSeriesResults = format(triplets, 'farm_id', 'imageId');
print(timeSeriesResults.first())

Export.table.toDrive({
  collection: timeSeriesResults,
  description: 'MODIS_NDVI_Series',
  folder: 'earthengine',
  fileNamePrefix: 'modis_ndvi_series',
  fileFormat: 'CSV'})